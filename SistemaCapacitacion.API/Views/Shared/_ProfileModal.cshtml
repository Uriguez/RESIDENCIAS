@model SistemaCapacitacion.Core.ViewModels.EditProfileViewModel

<div id="profileModal" class="modal">
    <div class="modal__dialog">
        <form asp-controller="Account" asp-action="UpdateProfile"
              method="post" enctype="multipart/form-data" id="profileForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="UserId" />

            <!-- HEADER -->
            <div class="modal__header">
                <div>
                    <div class="modal__title">Editar Mi Perfil</div>
                    <div class="admin-section-caption">
                        Actualiza tu información personal y de contacto en el sistema Griver.
                    </div>
                </div>

                <button type="button" class="btn btn--ghost" data-profile-close>
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>

            <!-- BODY -->
            <div class="modal__body">

                <!-- FOTO DE PERFIL -->
                <div class="settings-section card" style="margin-bottom:16px;">
                    <div class="settings-block__title" style="margin-bottom:10px;">
                        <span class="material-icons-outlined" style="font-size:18px; margin-right:4px;">photo_camera</span>
                        Foto de perfil
                    </div>

                    <div style="display:flex; gap:18px; align-items:flex-start;">
                        <div class="admin-topbar__avatar" style="width:92px; height:92px;">
                            @if (!string.IsNullOrEmpty(Model.CurrentPhotoUrl))
                            {
                                <!-- IMAGEN ACTUAL (con id para preview) -->
                                <img id="profileAvatarPreview" src="@Model.CurrentPhotoUrl" alt="Foto de perfil" />
                            }
                            else
                            {
                                <!-- INICIAL (cuando no hay foto) -->
                                <div id="profileAvatarInitial"
                                     style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;
                                font-weight:600;color:#4b5563;font-size:1.6rem;">
                                    @Model.FullName.FirstOrDefault()
                                </div>

                                <!-- IMG OCULTA para la previsualización -->
                                <img id="profileAvatarPreview" src="" alt="" style="display:none;" />
                            }
                        </div>

                        <div style="flex:1; font-size:0.82rem; color:#6b7280;">
                            <p style="margin-bottom:6px;">Recomendaciones para tu foto:</p>
                            <ul style="margin:0; padding-left:18px; line-height:1.4;">
                                <li>Formatos admitidos: JPG, PNG, GIF, WebP</li>
                                <li>Tamaño máximo: 5 MB</li>
                                <li>Resolución recomendada: 400x400 px mínimo</li>
                                <li>Usa una imagen cuadrada para mejores resultados</li>
                            </ul>

                            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                                <label class="btn btn--primary" style="cursor:pointer;">
                                    <span class="material-icons-outlined" style="font-size:18px;">cloud_upload</span>
                                    Cambiar foto
                                    <!-- IMPORTANTE: este id debe ser 'NewPhoto' -->
                                    <input asp-for="NewPhoto"
                                           id="NewPhoto"
                                           type="file"
                                           accept="image/*"
                                           style="display:none;" />
                                </label>

                                @if (!string.IsNullOrEmpty(Model.CurrentPhotoUrl))
                                {
                                    <button type="submit"
                                            name="removePhoto"
                                            value="true"
                                            class="btn btn--danger"
                                            style="padding:6px 12px;">
                                        <span class="material-icons-outlined" style="font-size:18px;">delete</span>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>


                <!-- INFORMACIÓN DE REFERENCIA -->
                <div class="settings-section card" style="margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <div class="settings-block__title">Información de referencia</div>
                            <div class="settings-block__caption">
                                Datos actuales registrados en el sistema Griver.
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                        <span class="badge badge--blue">
                            <span class="material-icons-outlined" style="font-size:16px;margin-right:4px;">admin_panel_settings</span>
                            @Model.Role
                        </span>
                        <span class="badge badge--gray">
                            <span class="material-icons-outlined" style="font-size:16px;margin-right:4px;">business</span>
                            @Model.Department
                        </span>
                        @if (Model.JoinDate.HasValue)
                        {
                            <span class="badge badge--gray">
                                <span class="material-icons-outlined" style="font-size:16px;margin-right:4px;">event</span>
                                Desde @Model.JoinDate.Value.ToString("dd/MM/yyyy")
                            </span>
                        }
                        <span class="badge @(Model.IsActive ? "badge--green" : "badge--red")">
                            <span class="material-icons-outlined" style="font-size:16px;margin-right:4px;">circle</span>
                            @(Model.IsActive ? "Activo" : "Inactivo")
                        </span>
                    </div>
                </div>

                <!-- FORMULARIO EDITABLE -->
                <div class="settings-section card">
                    <div class="settings-block__title" style="margin-bottom:8px;">
                        <span class="material-icons-outlined" style="font-size:18px; margin-right:4px;">edit</span>
                        Editar información
                    </div>

                    <div class="form-grid-2">
                        <div class="form-field">
                            <label class="form-label" asp-for="FullName">Nombre completo</label>
                            <input class="form-input" asp-for="FullName" />
                        </div>

                        <div class="form-field">
                            <label class="form-label" asp-for="Email">Correo electrónico</label>
                            <input class="form-input" asp-for="Email" readonly />
                        </div>

                        <div class="form-field">
                            <label class="form-label" asp-for="DepartmentId">Departamento</label>
                            <select class="form-select" asp-for="DepartmentId" asp-items="Model.Departments">
                                <option value="">Selecciona una opción</option>
                            </select>
                        </div>

                        <div class="form-field">
                            <label class="form-label">Rol en el sistema</label>
                            <input class="form-input" value="@Model.Role" readonly />
                        </div>

                        <div class="form-field">
                            <label class="form-label">Fecha de ingreso</label>
                            <input class="form-input" value="@(Model.JoinDate?.ToString("dd/MM/yyyy") ?? "-")" readonly />
                        </div>

                        <div class="form-field">
                            <label class="form-label">Estado</label>
                            <input class="form-input" value="@(Model.IsActive ? "Activo" : "Inactivo")" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" data-profile-close>
                    Cancelar
                </button>
                <button type="submit" class="btn btn--primary">
                    Guardar cambios
                </button>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputAvatar = document.getElementById('inputAvatar');
        const imgPreview = document.getElementById('imgPreview');

        if (inputAvatar && imgPreview) {
            inputAvatar.addEventListener('change', function(event) {
                const file = event.target.files[0];

                if (file) {
                    // Validar que sea imagen (opcional pero recomendado)
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor selecciona un archivo de imagen válido.');
                        return;
                    }

                    // Crear un lector de archivos
                    const reader = new FileReader();

                    // Cuando termine de leer, actualizar la imagen
                    reader.onload = function(e) {
                        imgPreview.src = e.target.result; // Asigna la nueva imagen
                    }

                    // Leer el archivo como URL de datos (base64)
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>