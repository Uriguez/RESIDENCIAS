@model SistemaCapacitacion.Core.ViewModels.AssignUsersToCourseViewModel

<div class="modal assign-users-modal" id="assignModal-@Model.CourseId">
    <div class="modal__dialog">
        <form asp-controller="Courses"
              asp-action="AssignUsers"
              method="post">
            @Html.AntiForgeryToken()

            <input type="hidden" name="CourseId" value="@Model.CourseId" />

            <!-- HEADER -->
            <div class="modal__header">
                <div>
                    <div class="modal__title">
                        Asignar usuarios al curso
                    </div>
                    <div class="admin-section-caption">
                        @Model.CourseTitle
                    </div>
                </div>

                <button type="button"
                        class="btn btn--ghost"
                        data-assign-close>
                    ✕
                </button>
            </div>

            <!-- BODY -->
            <div class="modal__body">
                <div class="settings-section card">
                    <div class="settings-block__title" style="margin-bottom:8px;">
                        Selecciona los usuarios a asignar
                    </div>

                    <div class="settings-block__caption" style="margin-bottom:10px;">
                        Los usuarios marcados quedarán vinculados a este curso.
                    </div>

                    <div style="max-height: 340px; overflow-y: auto;">
                        @if (Model.Users == null || !Model.Users.Any())
                        {
                            <div class="alert alert-light border">
                                No hay usuarios registrados en el sistema.
                            </div>
                        }
                        else
                        {
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"></th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var u in Model.Users)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                       name="SelectedUserIds"
                                                       value="@u.UserId" />
                                            </td>
                                            <td>@u.FullName</td>
                                            <td class="text-muted">@u.Email</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal__footer">
                <button type="button"
                        class="btn btn--secondary"
                        data-assign-close>
                    Cancelar
                </button>
                <button type="submit" class="btn btn--primary">
                    Guardar asignaciones
                </button>
            </div>
        </form>
    </div>
</div>
<script>
    // Función que se debe llamar al abrir el modal de asignación
    function prepareAssignModal(courseId) {
        
        // 1. Limpiar todos los checkboxes primero (resetear estado)
        const allCheckboxes = document.querySelectorAll('.user-checkbox'); // Asegúrate que tus checkbox tengan esta clase
        allCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.disabled = false;
            chk.parentElement.classList.remove('text-muted'); // Opcional: quitar color gris del texto
        });

        // 2. Establecer el ID del curso en el input oculto (si lo usas para el POST)
        // document.getElementById('InputCourseId').value = courseId; 

        // 3. Consultar a la API quiénes ya lo tienen
        fetch(`/api/Courses/${courseId}/assignments`)
            .then(response => response.json())
            .then(existingUserIds => {
                
                // 4. Recorrer los IDs que nos devolvió el servidor
                existingUserIds.forEach(userId => {
                    // Buscar el checkbox que tenga este value
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${userId}"]`);
                    
                    if (checkbox) {
                        checkbox.checked = true;    // Lo marcamos
                        checkbox.disabled = true;   // Lo bloqueamos (gris)
                        
                        Poner el texto en gris también para que se note más
                        checkbox.parentElement.classList.add('text-muted'); 
                    }
                });
            })
            .catch(error => console.error('Error cargando asignaciones:', error));
    }
</script>
