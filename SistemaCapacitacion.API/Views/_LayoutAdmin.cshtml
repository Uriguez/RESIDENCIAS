@using SistemaCapacitacion.Core.ViewModels
@using Microsoft.AspNetCore.Mvc.Rendering
@inject SistemaCapacitacion.Data.ApplicationDbContext Db

@{
    Layout = null;
    var controller = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
    var action = ViewContext.RouteData.Values["action"]?.ToString() ?? "";

    // ===== ViewModel del perfil para el modal =====
    var profileVm = new EditProfileViewModel();

    var claimId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    if (Guid.TryParse(claimId, out var idUser))
    {
        // Ajusta el nombre de la entidad y propiedades si difieren
        var user = Db.Users.FirstOrDefault(u => u.IdUser == idUser);

        if (user != null)
        {
            // Cargar departamentos activos desde dbo.Department
            var departments = Db.Departments
                .Where(d => d.IsActive == true)
                .OrderBy(d => d.Name)
                .ToList();

            int? currentDeptId = null;
            string currentDeptName = string.Empty;

            // Suponiendo que tu tabla User tiene la columna IdDepartment (FK)
            currentDeptId = user.DepartmentId;

            if (currentDeptId.HasValue)
            {
                currentDeptName = departments
                    .FirstOrDefault(d => d.IdDepartment == currentDeptId.Value)?.Name ?? string.Empty;
            }

            profileVm = new EditProfileViewModel
            {
                UserId = user.IdUser.ToString(),
                FullName = $"{user.FirstName} {user.LastName}".Trim(),
                Email = user.Email ?? string.Empty,
                // Si tienes un sistema de roles más avanzado, cambia este valor
                Role = "Administrador",
                DepartmentId = currentDeptId,
                Department = currentDeptName,
                IsActive = user.Status == "Active" || user.Status == "Activo",
                // De momento no usamos foto almacenada, así que la dejamos null
                CurrentPhotoUrl = user.PhotoUrl   // <--- AQUI
            };

            profileVm.Departments = departments
                .Select(d => new SelectListItem
                {
                    Value = d.IdDepartment.ToString(),
                    Text = d.Name,
                    Selected = currentDeptId.HasValue && currentDeptId.Value == d.IdDepartment
                })
                .ToList();
        }
    }
}

<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Griver</title>

    <!-- Bootstrap (opcional, por si lo usas en formularios/tablas) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
          rel="stylesheet" />
    <!-- Estilos globales del sitio -->
    <link rel="stylesheet" href="~/css/site.css" />
    <!-- Estilos del panel admin que ya tienes (admin.css) -->
    <link rel="stylesheet" href="~/css/admin.css" />
</head>
<body class="page-admin">
    <div class="admin-layout">

        <!-- =========================================================
             SIDEBAR IZQUIERDO
           ========================================================= -->
        <aside class="admin-sidebar">
            <!-- Marca lateral (logo Griver + texto) -->
            <div class="admin-sidebar__brand">
                <div class="admin-sidebar__brand-logo">
                    <!-- Ajusta la ruta del logo a la que tengas -->
                    <img src="~/img/logo.jpg" alt="Griver" />
                </div>
                <div class="admin-sidebar__brand-text">
                    <span class="admin-sidebar__brand-title">Griver</span>
                    <span class="admin-sidebar__brand-subtitle">
                        Sistema de Capacitación
                    </span>
                </div>
            </div>

            <div class="admin-sidebar__role-chip">
                <span class="admin-nav__icon">👤</span>
                @profileVm.Role
            </div>

            <!-- MENÚ PRINCIPAL -->
            <div class="admin-nav__section-label">Menú principal</div>
            <ul class="admin-nav">
                <li class="admin-nav__item">
                    <a class="admin-nav__link @(controller == "Admin" && action == "Dashboard" ? "admin-nav__link--active" : "")"
                       asp-controller="Admin" asp-action="Dashboard">
                        <span class="admin-nav__icon">🏠</span>
                        <span>Inicio</span>
                    </a>
                </li>
                <li class="admin-nav__item">
                    <a class="admin-nav__link @(controller == "Courses" && action == "Index" ? "admin-nav__link--active" : "")"
                       asp-controller="Courses" asp-action="Index">
                        <span class="admin-nav__icon">📚</span>
                        <span>Gestión de Cursos</span>
                    </a>
                </li>
                <li class="admin-nav__item">
                    <a class="admin-nav__link @(controller == "Admin" && action == "Users" ? "admin-nav__link--active" : "")"
                       asp-controller="Admin" asp-action="Users">
                        <span class="admin-nav__icon">👥</span>
                        <span>Gestión de Usuarios</span>
                    </a>
                </li>
                <li class="admin-nav__item">
                    <a class="admin-nav__link @(controller == "Admin" && action == "Analytics" ? "admin-nav__link--active" : "")"
                       asp-controller="Admin" asp-action="Analytics">
                        <span class="admin-nav__icon">📈</span>
                        <span>Analíticas Avanzadas</span>
                        <span class="badge badge--blue ms-auto">Pro</span>
                    </a>
                </li>
            </ul>

            <div class="admin-sidebar__footer">
                <a class="admin-sidebar__footer-link" asp-controller="Support" asp-action="Index">
                    <span>❓</span>
                    <span>Ayuda y Soporte</span>
                </a>
                <div>Griver Corporativo<br />v2.0.0 · 2025</div>

                <form asp-controller="Account" asp-action="Logout" method="post" class="mt-2">
                    @Html.AntiForgeryToken()
                    <button type="submit"
                            class="btn btn-sm btn-outline-danger w-100">
                        Cerrar sesión
                    </button>
                </form>
            </div>
        </aside>

        <!-- =========================================================
             CONTENEDOR DERECHO: TOPBAR + CONTENIDO
           ========================================================= -->
        <div class="admin-shell">

            <!-- HEADER SUPERIOR -->
            <header class="admin-topbar">
                <!-- Bloque de la izquierda: nombre del panel -->
                <div class="d-none d-md-flex flex-column me-auto">
                    <span class="admin-page-subtitle">
                        Panel Administrativo Griver
                    </span>
                </div>

                <!-- Reloj -->
                <div class="admin-topbar__clock">
                    <span class="admin-topbar__clock-icon">🕒</span>
                    <span id="adminClock">--:--</span>
                </div>

                <!-- Campana de notificaciones -->
                <button type="button"
                        id="btnNotifications"
                        class="admin-topbar__icon-btn admin-topbar__icon-btn--bell"
                        data-badge="2">
                    🔔
                </button>

                <!-- Perfil administrador -->
                <div class="admin-topbar__profile" id="profileToggle">
                    <div class="admin-topbar__avatar">
                        @if (!string.IsNullOrEmpty(profileVm.CurrentPhotoUrl))
                        {
                            <img src="@profileVm.CurrentPhotoUrl" alt="@profileVm.FullName" />
                        }
                        else
                        {
                            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#4b5563;">
                                @profileVm.FullName.FirstOrDefault()
                            </div>
                        }
                    </div>
                </div>

                <!-- Menú perfil desplegable -->
                <div class="profile-menu" id="profileMenu">
                    <div class="profile-menu__header">
                        <div class="profile-menu__name">@profileVm.FullName</div>
                        <div class="profile-menu__email">@profileVm.Email</div>
                        <div class="profile-menu__role">
                            @profileVm.Role@if (!string.IsNullOrEmpty(profileVm.Department)) {
                            @($" · {profileVm.Department}")
                                                        }
                        </div>
                    </div>
                    <ul class="profile-menu__list">
                        <li class="profile-menu__item">
                            <button type="button"
                                    class="profile-menu__link"
                                    data-open-profile-modal>
                                <span class="material-icons-outlined">person</span>
                                <span>Mi Perfil</span>
                            </button>
                        </li>

                        <li class="profile-menu__item">
                            <a class="profile-menu__link"
                               asp-controller="Admin" asp-action="Settings">
                                <span>⚙️</span>
                                <span>Configuración</span>
                            </a>
                        </li>
                        <li class="profile-menu__item">
                            <form asp-controller="Account" asp-action="Logout" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="profile-menu__link profile-menu__link--danger">
                                    <span>🚪</span>
                                    <span>Cerrar sesión</span>
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </header>

            <!-- PANEL DE NOTIFICACIONES (LATERAL) -->
            <aside class="notifications-panel" id="notificationsPanel">
                <div class="notifications-panel__header">
                    <span>Notificaciones</span>
                    <button type="button"
                            class="btn btn-sm btn-link text-decoration-none"
                            id="btnCloseNotifications">
                        Cerrar
                    </button>
                </div>
                <!-- Aquí luego llenas con notificaciones reales -->
                <div class="notifications-panel__item">
                    <div class="notifications-panel__title">Nuevo curso asignado</div>
                    <div class="notifications-panel__type">
                        Se te asignó un nuevo curso.
                    </div>
                    <div class="notifications-panel__time">
                        hace 3 horas
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="admin-main">
                @RenderBody()
            </main>
        </div>
    </div>

    <!-- ======== MODAL DE PERFIL (partial) ======== -->
    @await Html.PartialAsync("_ProfileModal", profileVm)

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Reloj en la barra superior
        const clockEl = document.getElementById('adminClock');

        if (clockEl) {
            const tick = () => {
                const now = new Date();
                clockEl.textContent = now.toLocaleTimeString('es-MX', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            tick();
            setInterval(tick, 60000);
        }

        // Menú perfil
        const profileToggle = document.getElementById('profileToggle');
        const profileMenu   = document.getElementById('profileMenu');

        if (profileToggle && profileMenu) {
            profileToggle.addEventListener('click', () => {
                profileMenu.classList.toggle('profile-menu--open');
            });

            document.addEventListener('click', (e) => {
                if (!profileMenu.contains(e.target) && !profileToggle.contains(e.target)) {
                    profileMenu.classList.remove('profile-menu--open');
                }
            });
        }

        // Panel de notificaciones
        const btnNotifications      = document.getElementById('btnNotifications');
        const btnCloseNotifications = document.getElementById('btnCloseNotifications');
        const notificationsPanel    = document.getElementById('notificationsPanel');

        if (btnNotifications && notificationsPanel) {
            btnNotifications.addEventListener('click', () => {
                notificationsPanel.classList.toggle('notifications-panel--open');
            });
        }

        if (btnCloseNotifications && notificationsPanel) {
            btnCloseNotifications.addEventListener('click', () => {
                notificationsPanel.classList.remove('notifications-panel--open');
            });
        }

        // ===== Modal de perfil (abrir/cerrar) =====
        const profileModal        = document.getElementById('profileModal');
        const openProfileButtons  = document.querySelectorAll('[data-open-profile-modal]');
        const closeProfileButtons = document.querySelectorAll('[data-profile-close]');

        if (profileModal) {
            openProfileButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    profileModal.classList.add('modal--open');
                    if (profileMenu) profileMenu.classList.remove('profile-menu--open');
                });
            });

            closeProfileButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    profileModal.classList.remove('modal--open');
                });
            });

            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    profileModal.classList.remove('modal--open');
                }
            });
        }

        // ===== Previsualización de foto de perfil =====
        const photoInput = document.getElementById('NewPhoto');          // <-- simple y directo
        const avatarImg  = document.getElementById('profileAvatarPreview');
        const avatarInit = document.getElementById('profileAvatarInitial');

        if (photoInput && avatarImg) {
            photoInput.addEventListener('change', function (e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                const file = files[0];
                const reader = new FileReader();

                reader.onload = function (ev) {
                    avatarImg.src = ev.target.result;
                    avatarImg.style.display = 'block';
                    if (avatarInit) {
                        avatarInit.style.display = 'none';
                    }
                };

                reader.readAsDataURL(file);
            });
        }
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>

