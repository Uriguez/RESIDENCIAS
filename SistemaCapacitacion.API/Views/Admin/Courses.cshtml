@model SistemaCapacitacion.Core.ViewModels.CoursesAdminViewModel
   
@{
    Layout = "~/Views/_LayoutAdmin.cshtml";  // RUTA COMPLETA
    bool isAdmin = User.IsInRole("Admin");
    bool isRH    = User.IsInRole("RH");

    var createCourseVm = ViewBag.CreateCourseVm as SistemaCapacitacion.Core.ViewModels.CreateCourseViewModel
                      ?? new SistemaCapacitacion.Core.ViewModels.CreateCourseViewModel();
}

<section class="admin-main-section">
    <!-- HEADER PRINCIPAL -->
    <header class="admin-header">
        <div>
            <h1 class="admin-page-title">Gestión de Cursos</h1>
            <p class="admin-page-subtitle">
                Administra el catálogo de cursos de capacitación de Griver.
            </p>
        </div>

        <div class="admin-section-actions">
            <button class="btn btn--secondary">
                <span>⬇</span> 
                <span>Exportar usuarios</span>
            </button>
            @if (isAdmin)
                    {
            <button type="button"
                    class="btn btn--primary"
                    data-open-course-modal>
                + Nuevo Curso
            </button>
                    }
        </div>
    </header>

    <!-- FILTROS + BUSCADOR -->
    <article class="card p-3 mb-3">
        <div class="mb-2">
            <div class="admin-section-title">Filtros</div>
            <div class="admin-section-caption">
                Busca y filtra los cursos según su estado.
            </div>
        </div>

        <form method="get" class="mb-3">
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">🔍</span>
                        <input type="text"
                               name="search"
                               value="@Model.SearchTerm"
                               class="form-control"
                               placeholder="Buscar cursos..." />
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="filters-bar">
                        @{
                            string state = Model.StateFilter?.ToLowerInvariant() ?? "all";
                            string chipClass(string value) =>
                                "filter-chip" + (state == value ? " filter-chip--active" : "");
                        }

                        <button type="submit"
                                name="state"
                                value="all"
                                class="@chipClass("all")">
                            Todos
                        </button>
                        <button type="submit"
                                name="state"
                                value="active"
                                class="@chipClass("active")">
                            Activos
                        </button>
                        <button type="submit"
                                name="state"
                                value="inactive"
                                class="@chipClass("inactive")">
                            Borradores
                        </button>
                        <button type="submit"
                                name="state"
                                value="archived"
                                class="@chipClass("archived")">
                            Archivados
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- MÉTRICAS SUPERIORES -->
        <div class="metric-grid">
            <article class="metric-card">
                <div class="metric-card__label">
                    <span class="metric-card__icon">📦</span>
                    <span>Total Cursos</span>
                </div>
                <div class="metric-card__value">@Model.TotalCourses</div>
                <div class="metric-card__delta">
                    +X desde el mes pasado
                </div>
            </article>

            <article class="metric-card">
                <div class="metric-card__label">
                    <span class="metric-card__icon">✅</span>
                    <span>Cursos Activos</span>
                </div>
                <div class="metric-card__value">@Model.ActiveCourses</div>
                <div class="metric-card__delta">
                    @((Model.TotalCourses == 0
                        ? 0
                        : Math.Round(100.0 * Model.ActiveCourses / Model.TotalCourses, 1)))% del total
                </div>
            </article>

            <article class="metric-card">
                <div class="metric-card__label">
                    <span class="metric-card__icon">👥</span>
                    <span>Empleados Totales</span>
                </div>
                <div class="metric-card__value">@Model.TotalStudents</div>
                <div class="metric-card__delta">
                    Across all courses
                </div>
            </article>

            <article class="metric-card">
                <div class="metric-card__label">
                    <span class="metric-card__icon">📈</span>
                    <span>Tasa Promedio</span>
                </div>
                <div class="metric-card__value">
                    @Model.AverageCompletion.ToString("0.0")%
                </div>
                <div class="metric-card__delta">
                    Completion rate
                </div>
            </article>
        </div>
    </article>

    <!-- LISTADO DE CURSOS -->
    <section>
        <header class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="admin-section-title">
                Cursos (@Model.Courses.Count)
            </h2>
        </header>

        @if (!Model.Courses.Any())
        {
            <div class="alert alert-light border">
                No hay cursos registrados con los filtros actuales.
            </div>
        }
        else
        {
            <div class="courses-grid">
                @foreach (var c in Model.Courses)
                {
                    <article class="course-card">
                        <div class="course-card__header">
                            <div>
                                <div class="course-card__title">@c.Title</div>
                                <div class="course-card__meta">
                                    @c.Category
                                </div>
                            </div>

                            <div class="d-flex flex-column align-items-end gap-1">
                                <span class="badge @(c.IsActive ? "badge--green" : "badge--gray")">
                                    @(c.IsActive ? "Activo" : "Inactivo")
                                </span>
                            </div>
                        </div>

                        <p class="mb-2">
                            @c.Description
                        </p>

                        <div class="d-flex flex-wrap gap-3 mb-2 small text-muted">
                            <span>⏱ @c.DurationMinutes min</span>
                            <span>👥 @c.StudentsCount estudiantes</span>
                            <span>@c.CompletionPercent.ToString("0.0")% completado</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
                            <span>Creado: @c.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button"
                                    class="btn btn-sm btn--secondary js-view-course"
                                    data-course-id="@c.IdCourse">
                                Ver
                            </button>

                            @if (isAdmin)
                            {
                                <button type="button"
                                        class="btn btn-sm btn--secondary js-edit-course"
                                        data-course-id="@c.IdCourse">
                                    Editar
                                </button>

                                <form asp-controller="Courses"
                                      asp-action="DeleteCourse"
                                      asp-route-id="@c.IdCourse"
                                      method="post"
                                      class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit"
                                            class="btn btn-sm btn--danger"
                                            onclick="return confirm('¿Eliminar este curso? Esta acción no se puede deshacer.');">
                                        Eliminar
                                    </button>
                                </form>
                            }

                            @* Solo Recursos Humanos ve el botón Asignar *@
                            @if (isRH)
                            {
                                <button type="button"
                                        class="btn btn--primary"
                                        data-open-assign-modal
                                        data-assign-modal-id="assignModal-@c.IdCourse"
                                        onclick="prepareAssignModal(@c.IdCourse, 'assignModal-@c.IdCourse')">
                                    Asignar
                                </button>
                            }
                        </div>
                    </article>
                    @if (isRH)
                    {
                        var assignVm = new SistemaCapacitacion.Core.ViewModels.AssignUsersToCourseViewModel
                        {
                            CourseId = c.IdCourse,
                            CourseTitle = c.Title,
                            Users = Model.AllUsers
                        };
                        @await Html.PartialAsync("~/Views/Courses/_AssignUsersModal.cshtml", assignVm)

                    }
                }
            </div>
        }
    </section>
</section>

@await Html.PartialAsync("~/Views/Admin/_CreateCourseModal.cshtml", createCourseVm)

@section Scripts {
    <script>
        // ===== Modal de NUEVO CURSO =====
        const courseModal        = document.getElementById('courseModal');
        const openCourseButtons  = document.querySelectorAll('[data-open-course-modal]');
        const closeCourseButtons = document.querySelectorAll('[data-course-close]');

        if (courseModal) {
            openCourseButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    courseModal.classList.add('modal--open');
                });
            });

            closeCourseButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    courseModal.classList.remove('modal--open');
                });
            });

            courseModal.addEventListener('click', (e) => {
                if (e.target === courseModal) {
                    courseModal.classList.remove('modal--open');
                }
            });
        }

        // ===== Modales de ASIGNAR USUARIOS A CURSO =====
        const assignButtons = document.querySelectorAll('[data-open-assign-modal]');
        assignButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.getAttribute('data-assign-modal-id');
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('modal--open');
            });
        });

        const closeAssignButtons = document.querySelectorAll('[data-assign-close]');
        closeAssignButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.closest('.modal');
                if (modal) modal.classList.remove('modal--open');
            });
        });

        document.querySelectorAll('.modal.assign-users-modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('modal--open');
                }
            });
        });
                document.querySelectorAll('.js-edit-course').forEach(btn => {
          btn.addEventListener('click', async () => {
            try {
              const id = btn.getAttribute('data-course-id');

              // 1) Pedir datos a BD vía API
              const r = await fetch(`/api/Courses/${id}`);
              if (!r.ok) throw new Error(await r.text());
              const course = await r.json();

              // 2) Precargar inputs del modal existente (el mismo de Crear)
              document.getElementById('EditCourseId').value = course.idCourse;
              document.getElementById('Title').value = course.title ?? '';
              document.getElementById('Title').readOnly = true; // NO editable
              document.getElementById('CategoryId').value = course.categoryId ?? '';
              document.getElementById('Description').value = course.description ?? '';
                document.getElementById('IsActive').checked = !!course.isActive;

            // =======================================================
            //       CÓDIGO DE LA VISUALIZACIÓN DE PDF O VIDEOS
            // =======================================================

                const previewContainer = document.getElementById('uploadPreview');
                const dropzoneText = document.getElementById('dropzoneHint'); // O el elemento de texto que tengas

                // Limpiar previo
                if (previewContainer) previewContainer.innerHTML = '';

                // Verificar si el objeto 'course' trae la info del contenido (ajusta según tu JSON de respuesta)
                // Nota: En tu controlador API debes asegurarte de devolver 'content' dentro del objeto json
                if (course.content && course.content.contentUrl) {

                    // Rellenar inputs ocultos de contenido si existen
                    if (document.getElementById('ContentTitle'))
                        document.getElementById('ContentTitle').value = course.content.title;
                    if (document.getElementById('ContentUrl'))
                        document.getElementById('ContentUrl').value = course.content.contentUrl;

                    // MOSTRAR ARCHIVO ACTUAL
                    if (previewContainer) {
                        let archivoHTML = '';
                        // Tipo 1 = Video, Tipo 2 = Documento
                        if (course.content.contentType === 1) {
                            archivoHTML = `
                                <div class="existing-file-alert success">
                                    <span class="material-icons-outlined">play_circle</span>
                                    <div>
                                        <strong>Video actual cargado</strong><br>
                                        <a href="${course.content.contentUrl}" target="_blank">Ver video actual</a>
                                    </div>
                                </div>`;
                        } else {
                            archivoHTML = `
                                <div class="existing-file-alert info">
                                    <span class="material-icons-outlined">description</span>
                                    <div>
                                        <strong>Documento actual cargado</strong><br>
                                        <a href="${course.content.contentUrl}" target="_blank">Ver documento</a>
                                    </div>
                                </div>`;
                        }
                        previewContainer.innerHTML = archivoHTML;
                    }
                } else {
                    // Si no hay contenido, limpiar mensaje
                    if (previewContainer) previewContainer.innerHTML = '';
                }

              // 3) Cambiar texto del modal (opcional)
              const courseModal = document.getElementById('courseModal');
              const titleEl  = courseModal.querySelector('.modal__title');
              const submitEl = courseModal.querySelector('.modal__footer button[type="submit"]');
              if (titleEl) titleEl.textContent = 'Editar curso';
              if (submitEl) submitEl.textContent = 'Guardar cambios';

              // 4) Abrir modal
              courseModal.classList.add('modal--open');

            } catch (e) {
              console.error(e);
              alert('No se pudieron cargar los datos del curso para edición.');
            }
          });
        });

        //--------------------------EDITAR--------------------------------------//

                document.addEventListener('DOMContentLoaded', () => {
          const courseModal = document.getElementById('courseModal');
          const courseForm  = courseModal?.querySelector('form');

          if (!courseForm) return;

          // Evitar registrar el handler múltiples veces si recargas parcial/scripts
          if (window.__courseEditSubmitBound) return;
          window.__courseEditSubmitBound = true;

          courseForm.addEventListener('submit', async (e) => {
            const editId = document.getElementById('EditCourseId')?.value;

            // Si NO hay id -> es Crear -> se deja tu flujo actual intacto
            if (!editId) return;

            // Si hay id -> es Edición -> cancelar POST CreateCourse
            e.preventDefault();
            e.stopImmediatePropagation();

            try {
              // PUT /api/Courses/{id} (tu endpoint absoluto)
              const payload = {
                description: document.getElementById('Description').value,
                categoryId: Number(document.getElementById('CategoryId').value) || null,
                isActive: document.getElementById('IsActive').checked,

                // Si ya estás actualizando contenido, agrega aquí lo necesario:
                contentId: Number(document.getElementById('EditContentId')?.value) || null,
                contentTitle: document.getElementById('ContentTitle').value,
                contentType: Number(document.getElementById('ContentType').value) || 0,
                contentUrl: document.getElementById('ContentUrl').value,
                durationMinutes: Number(document.getElementById('DurationMinutes').value) || 0,
                minimumScore: Number(document.getElementById('MinimumScore').value) || 0,
                isRequired: document.getElementById('IsRequired').checked
              };

              const r = await fetch(`/api/Courses/${editId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!r.ok) throw new Error(await r.text());

              // Cerrar modal y limpiar modo edición
              courseModal.classList.remove('modal--open');
              document.getElementById('EditCourseId').value = '';
              const titleInput = document.getElementById('Title');
              if (titleInput) titleInput.readOnly = false;

              location.reload();
            } catch (err) {
              console.error(err);
              alert('No se pudieron guardar los cambios.');
            }
          }, true); // 👈 capture=true: se ejecuta antes del submit normal
        });


                // ====== Dropzone Upload (Video/Documento) ======
        (function(){
          const dropzoneField = document.getElementById('dropzoneField');
          const dropzone = document.getElementById('dropzone');
          const fileInput = document.getElementById('ContentFile');
          const uploadStatus = document.getElementById('uploadStatus');
          const uploadPreview = document.getElementById('uploadPreview');
          const hint = document.getElementById('dropzoneHint');

          const contentType = document.getElementById('ContentType'); // 1,2,3
          const contentUrl = document.getElementById('ContentUrl');
          const contentUrlField = document.getElementById('contentUrlField'); // si lo envolviste

          if(!dropzone || !fileInput || !contentType || !contentUrl) return;

          function setStatus(msg){ if(uploadStatus) uploadStatus.textContent = msg || ''; }

          function renderPreview(url, type){
            if(!uploadPreview) return;
            uploadPreview.innerHTML = '';
            if(!url) return;

            if(Number(type) === 1){
              uploadPreview.innerHTML = `
                <video controls style="width:100%; max-height:360px; border-radius:12px;">
                  <source src="${url}" type="video/mp4">
                </video>`;
              return;
            }

            if(url.toLowerCase().endsWith('.pdf')){
              uploadPreview.innerHTML = `<iframe src="${url}" style="width:100%; height:380px; border:0; border-radius:12px;"></iframe>`;
              return;
            }

            uploadPreview.innerHTML = `<a class="btn btn--secondary" href="${url}" target="_blank" rel="noopener">Abrir archivo</a>`;
          }

          function allowedForType(file, type){
            // type: 1 video, 2 documento, 3 enlace
            if(Number(type) === 1){
              // mp4 (puedes ampliar a video/* si quieres)
              return file.type === 'video/mp4' || file.name.toLowerCase().endsWith('.mp4');
            }
            if(Number(type) === 2){
              const name = file.name.toLowerCase();
              return (
                name.endsWith('.pdf') || name.endsWith('.doc') || name.endsWith('.docx') ||
                name.endsWith('.ppt') || name.endsWith('.pptx') || name.endsWith('.xls') ||
                name.endsWith('.xlsx') || name.endsWith('.png') || name.endsWith('.jpg') ||
                name.endsWith('.jpeg')
              );
            }
            return false;
          }

          async function uploadFile(file){
            const type = Number(contentType.value);

            if(!allowedForType(file, type)){
              setStatus('Archivo no permitido para el tipo seleccionado.');
              return;
            }

            setStatus('Subiendo archivo...');
            const fd = new FormData();
            fd.append('file', file);

            const r = await fetch('/api/Upload/content', { method: 'POST', body: fd });
            if(!r.ok){
              setStatus('Error al subir el archivo.');
              return;
            }
            const data = await r.json();

            // Guardar URL resultante en el campo que ya se persiste en BD
            contentUrl.value = data.url || '';
            setStatus('Archivo subido correctamente.');
            renderPreview(contentUrl.value, type);
          }

          function updateUI(){
            const type = Number(contentType.value);

            if(type === 1 || type === 2){
              // Video/Documento: mostrar dropzone, ocultar url visible
              if(dropzoneField) dropzoneField.style.display = '';
              if(contentUrlField) contentUrlField.style.display = 'none';

              hint.textContent = (type === 1)
                ? 'Formato permitido: .mp4'
                : 'Formatos permitidos: PDF, DOC/DOCX, PPT/PPTX, XLS/XLSX, PNG/JPG';

              // si ya hay URL precargada, mostrar preview
              renderPreview(contentUrl.value, type);

            } else {
              // Enlace externo: ocultar dropzone, mostrar URL
              if(dropzoneField) dropzoneField.style.display = 'none';
              if(contentUrlField) contentUrlField.style.display = '';

              setStatus('');
              if(uploadPreview) uploadPreview.innerHTML = '';
              fileInput.value = '';
            }
          }

          contentType.addEventListener('change', updateUI);
          updateUI();

          // Click abre selector
          dropzone.addEventListener('click', () => fileInput.click());
          dropzone.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.key === ' ') fileInput.click();
          });

          // Input change
          fileInput.addEventListener('change', async () => {
            const f = fileInput.files && fileInput.files[0];
            if(f) await uploadFile(f);
          });

          // Drag events
          dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dropzone--over');
          });

          dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dropzone--over');
          });

          dropzone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropzone.classList.remove('dropzone--over');

            const f = e.dataTransfer.files && e.dataTransfer.files[0];
            if(f) await uploadFile(f);
          });
        })();

        ///-----------------------LIMPIAR SECCION DE CREAR CURSO PARA QUE NO TENGA CONFLICTOS CON EL DE CREAR CURSO----------------------------//
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Identificar el botón de "Nuevo Curso" usando su atributo data
            const btnNuevoCurso = document.querySelector('[data-open-course-modal]');

            // 2. Identificar el formulario y los elementos clave del modal
            const courseForm = document.getElementById('courseForm');
            const modalTitle = document.getElementById('courseModalTitle');
            const hiddenId = document.getElementById('EditCourseId'); // ID que usas para saber si es edición
            const hiddenContentId = document.getElementById('EditContentId');
            const submitBtn = document.getElementById('courseSubmitBtn'); // Botón de enviar del modal

            if (btnNuevoCurso) {
                btnNuevoCurso.addEventListener('click', () => {
                    // A) CAMBIAR TÍTULO Y TEXTOS VISUALES
                    if (modalTitle) modalTitle.innerText = 'Crear Nuevo Curso';
                    if (submitBtn) submitBtn.innerText = 'Crear curso';

                    // B) LIMPIAR EL FORMULARIO COMPLETO
                    if (courseForm) {
                        courseForm.reset();
                        // .reset() borra textos, checkboxes y selects a su valor por defecto

                        // Si tienes validaciones de ASP.NET (jQuery Validation), esto limpia los mensajes de error rojos:
                        // $(courseForm).validate().resetForm(); // Descomenta si usas jQuery Validation
                        const errorSpans = courseForm.querySelectorAll('.text-danger');
                        errorSpans.forEach(span => span.innerText = ''); // Limpieza manual de errores
                    }

                    // C) RESETEAR IDs OCULTOS (CRUCIAL)
                    // Esto le dice al controlador que es un registro NUEVO (ID = 0 o vacío)
                    if (hiddenId) hiddenId.value = '';
                    if (hiddenContentId) hiddenContentId.value = '';

                    // D) RESETEAR ELEMENTOS UI PERSONALIZADOS
                    // Si tu Dropzone o vista previa de imagen se quedan con la imagen anterior:
                    const uploadPreview = document.getElementById('uploadPreview');
                    const dropzoneField = document.getElementById('dropzoneField');
                    if (uploadPreview) uploadPreview.innerHTML = '';
                    if (dropzoneField) dropzoneField.style.display = 'block'; // Volver a mostrar zona de carga

                    // Si manipulas la acción del formulario en Edición, regrésala a "Create"
                    courseForm.setAttribute('action', '/Courses/CreateCourse');
                    courseForm.setAttribute('method', 'post');
                });
            }

        });
    </script>
}
